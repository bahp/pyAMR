
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples\reports\nhs\plot_antibiogram_clustermap.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_reports_nhs_plot_antibiogram_clustermap.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_reports_nhs_plot_antibiogram_clustermap.py:


SARI - Antibiogram (clustered)
------------------------------

.. todo:: Explain and Simplify

.. todo: Frequency might not be working?
         Frequency can be computed as sum of columns.

.. GENERATED FROM PYTHON SOURCE LINES 11-210



.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /_examples/reports/nhs/images/sphx_glr_plot_antibiogram_clustermap_001.png
          :alt: Antibiogram (clustered) - BLDCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/reports/nhs/images/sphx_glr_plot_antibiogram_clustermap_002.png
          :alt: Antibiogram (clustered) - GUMCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/reports/nhs/images/sphx_glr_plot_antibiogram_clustermap_003.png
          :alt: Antibiogram (clustered) - SPTCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/reports/nhs/images/sphx_glr_plot_antibiogram_clustermap_004.png
          :alt: Antibiogram (clustered) - URICUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/reports/nhs/images/sphx_glr_plot_antibiogram_clustermap_005.png
          :alt: Antibiogram (clustered) - WOUCUL
          :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none




    Data (BLDCUL)
    ANTIBIOTIC                            AAMI             AAMO        AAZT  ...          ATIG            ATOB         AVAN
    antimicrobial_class        Aminoglycosides Aminopenicillins Monobactams  ... Tetracyclines Aminoglycosides Glycopeptide
    SPECIE microorganism_genus                                               ...                                           
    AHS    Streptococcus                     0                0           0  ...             0               0            0
    BHSA   Streptococcus                     0                0           0  ...             0               0            0
    BHSB   Streptococcus                     0                0           0  ...             0               0            0
    CNS    Staphylococcus                    0                0           0  ...             0               0            0
    CORYN  Corynebacterium                   0                0           0  ...             0               0            1
    ECLO   Enterobacter                      3               87          18  ...            22              16            0
    ECOL   Escherichia                       1               72          19  ...             1              22            0
    EFAM   Enterococcus                      0               96           0  ...             0               0           35
    EFAS   Enterococcus                      0                0           0  ...             0               0            0
    ENTB   Enterobacter                      1               89          23  ...             0              15            0
    ENTC   Enterococcus                      0               61           0  ...             0               0           45
    KLEBS  Klebsiella                        2               98          18  ...            22              17            0
    KOXY   Klebsiella                        0                0          13  ...             6               5            0
    KPNE   Klebsiella                        4               99          26  ...            32              28            0
    MICROC Micrococcus                       0                0           0  ...             0               0            0
    PAER   Pseudomonas                       3                0          67  ...             0               5            0
    PMIR   Proteus                           1               33           1  ...            55               8            0
    SALMO  Salmonella                        0                0           0  ...             0               0            0
    SAUR   Staphylococcus                    0                0           0  ...             0               0            0
    SEPI   Staphylococcus                    0                0           0  ...             0               0            0
    SMAL   Stenotrophomonas                  0                0           0  ...             0               0            0
    SMAR   Serratia                          0                0           3  ...            40              29            0
    SPNE   Streptococcus                     0                0           0  ...             0               0            0

    [23 rows x 30 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (GUMCUL)
    ANTIBIOTIC                       AAZI             ACIP           ACIX          ACONE           ACXM             ANAL          ATET
    antimicrobial_class        Macrolides Fluoroquinolones Cephalosporins Cephalosporins Cephalosporins Fluoroquinolones Tetracyclines
    SPECIE microorganism_genus                                                                                                        
    NGON   Neisseria                    0               39              0              0              3               38            76
    NMEN   Neisseria                    1                8              0              0              0                5             0
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (SPTCUL)
    ANTIBIOTIC                            AAMI             AAMO        AAZT  ...          ATIG            ATOB         AVAN
    antimicrobial_class        Aminoglycosides Aminopenicillins Monobactams  ... Tetracyclines Aminoglycosides Glycopeptide
    SPECIE microorganism_genus                                               ...                                           
    ABAU   Acinetobacter                    50               98           0  ...             0              57            0
    A_NURF Normal                            0                0           0  ...             0               0            0
    BHSB   Streptococcus                     0                0           0  ...             0               0            0
    CITRO  Citrobacter                       0               85           0  ...             0               0            0
    CKOS   Citrobacter                       1               98           1  ...             2               0            0
    COLIF  Coliform                          2               81          12  ...            13              12            0
    EAER   Enterobacter                      0               91          28  ...            16               1            0
    ECLO   Enterobacter                      0               85          22  ...            18               8            0
    ECOL   Escherichia                       2               84          25  ...             1              24            0
    ENTB   Enterobacter                      0               91          21  ...            10               5            0
    ENTC   Enterococcus                      0               60           0  ...             0               0           44
    HINF   Haemophilus                       0               24           0  ...             0               0            0
    KLEBS  Klebsiella                        1               98          24  ...            22              21            0
    KOXY   Klebsiella                        0               96          11  ...             9               4            0
    KPNE   Klebsiella                        1               97          16  ...            18              17            0
    LFC    Coliform                          0               83           0  ...             0               0            0
    MCAT   Moraxella                         0               90           0  ...             0               0            0
    PAER   Pseudomonas                       3                0          60  ...             0               7            0
    PMIR   Proteus                           8               48           9  ...            37              20            0
    PROTE  Proteus                           0               40           0  ...             0               0            0
    PSEUD  Pseudomonas                       6                0          51  ...             0              13            0
    SAUR   Staphylococcus                    0                0           0  ...             0               0            0
    SERRA  Serratia                          0               94           1  ...            12               4            0
    SMAL   Stenotrophomonas                  0                0           0  ...             0               0            0
    SMAR   Serratia                          1               97           3  ...            15              11            0
    SPNE   Streptococcus                     0                0           0  ...             0               0            0

    [26 rows x 32 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (URICUL)
    ANTIBIOTIC                            AAMI             AAMO        AAZT  ...          ATIG            ATOB         AVAN
    antimicrobial_class        Aminoglycosides Aminopenicillins Monobactams  ... Tetracyclines Aminoglycosides Glycopeptide
    SPECIE microorganism_genus                                               ...                                           
    ABAU   Acinetobacter                     0                0           0  ...             0               0            0
    ACINE  Acinetobacter                     4                0           0  ...             0               0            0
    BHSB   Streptococcus                     0                0           0  ...             0               0            0
    CFRE   Citrobacter                       4                0           0  ...             0               0            0
    CITRO  Citrobacter                       1                0           0  ...             0               0            0
    CKOS   Citrobacter                       0                0           0  ...             0               0            0
    CNS    Staphylococcus                    0                0           0  ...             0               0            0
    COLIF  Coliform                          1                0           0  ...             0               0            0
    EAER   Enterobacter                      0                0           0  ...             0               0            0
    ECLO   Enterobacter                      0                0           0  ...             0               0            0
    ECOL   Escherichia                       1               13           0  ...             0              53            0
    EFAM   Enterococcus                      0               98           0  ...             0               0           30
    EFAS   Enterococcus                      0                0           0  ...             0               0            5
    ENTB   Enterobacter                      0                0           0  ...             0               0            0
    ENTC   Enterococcus                      0                4           0  ...             0               0            2
    KLEBS  Klebsiella                        5                0           0  ...             0               0            0
    KPNE   Klebsiella                        7                0           0  ...             0               0            0
    MMOR   Morganella                        0                0           0  ...             0               0            0
    PAER   Pseudomonas                       2                0          63  ...             0              18            0
    PMIR   Proteus                           6                0           0  ...             0               0            0
    PROTE  Proteus                           4                0           0  ...             0               0            0
    PSEUD  Pseudomonas                       1                0          69  ...             0              14            0
    SAUR   Staphylococcus                    0                0           0  ...             0               0            0
    SERRA  Serratia                          0                0           0  ...             0               0            0
    SMAL   Stenotrophomonas                  0                0           0  ...             0               0            0
    SMAR   Serratia                          0                0           0  ...             0               0            0
    SSAP   Staphylococcus                    0                0           0  ...             0               0            1

    [27 rows x 29 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (WOUCUL)
    ANTIBIOTIC                                 AAMI             AAMO       AAZI  ...          ATIG            ATOB         AVAN
    antimicrobial_class             Aminoglycosides Aminopenicillins Macrolides  ... Tetracyclines Aminoglycosides Glycopeptide
    SPECIE      microorganism_genus                                              ...                                           
    ABAU        Acinetobacter                    32               97          0  ...            38              36            0
    ACINE       Acinetobacter                     2               43          0  ...            12              10            0
    AHS         Streptococcus                     0                0          0  ...             0               0            0
    ALWO        Acinetobacter                     0                1          0  ...             0               0            0
    A_ANAEROBE  Anaerobes                         0                0          0  ...             0               0            0
    A_ISOLATED  Isolated                          0                0          0  ...             0               0            0
    A_MANAEROBE Anaerobes                         0                0          0  ...             0               0            0
    BACIL       Bacillus                          0                0          0  ...             0               0            2
    BHSA        Streptococcus                     0                0          0  ...             0               0            0
    BHSB        Streptococcus                     0                0          0  ...             0               0            0
    BHSC        Streptococcus                     0                0          0  ...             0               0            0
    BHSCG       Streptococcus                     0                0          0  ...             0               0            0
    CITRO       Citrobacter                       0               92          0  ...             0               0            0
    CKOS        Citrobacter                       0               96          0  ...             0               0            0
    CNS         Staphylococcus                    0                0          0  ...             0               0            0
    COLIF       Coliform                          2               70          0  ...             8              12            0
    CORYN       Corynebacterium                   0                0          0  ...             0               0            0
    EAER        Enterobacter                      0               98          0  ...             0               0            0
    ECLO        Enterobacter                      1               91          0  ...            16               9            0
    ECOL        Escherichia                       2               79          0  ...             2              36            0
    EFAM        Enterococcus                      0               97          0  ...             0               0           17
    EFAS        Enterococcus                      0                0          0  ...             0               0            0
    ENTB        Enterobacter                      0               92          0  ...            13               6            0
    ENTC        Enterococcus                      0               38          0  ...             0               0           28
    KLEBS       Klebsiella                        6               98          0  ...            27              53            0
    KOXY        Klebsiella                        1               96          0  ...             0               0            0
    KPNE        Klebsiella                       11               99          0  ...            27              58            0
    LFC         Coliform                          1               70          0  ...             5               8            0
    MMOR        Morganella                        0               96          0  ...            12               7            0
    NGON        Neisseria                         0                0          0  ...             0               0            0
    NLF         Non-Coliform                      0                0          0  ...             0               0            0
    NMEN        Neisseria                         0                0          0  ...             0               0            0
    PAER        Pseudomonas                       1                0          0  ...             0               5            0
    PMIR        Proteus                           4               32          0  ...            33              14            0
    PROTE       Proteus                           1               32          0  ...            22              12            0
    PSEUD       Pseudomonas                       2                0          0  ...             0               8            0
    SAUR        Staphylococcus                    0                0          0  ...             0               0            0
    SERRA       Serratia                          2               96          0  ...            18               8            0
    SMAL        Stenotrophomonas                  0                0          0  ...             0               0            0
    SMAR        Serratia                          0               98          0  ...            18               8            0
    SMIL        Streptococcus                     0                0          0  ...             0               0            0
    SPNE        Streptococcus                     0                0          0  ...             0               0            0

    [42 rows x 34 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)






|

.. code-block:: default
   :lineno-start: 12


    # Libraries
    import sys
    import glob
    import numpy as np 
    import pandas as pd 
    import seaborn as sns
    import matplotlib as mpl
    import matplotlib.pyplot as plt

    # Import own libraries
    from pyamr.core.freq import Frequency
    from pyamr.core.sari import SARI
    from pyamr.datasets.load import load_data_nhs

    # -------------------------
    # Configuration
    # -------------------------
    # Configure seaborn style (context=talk)
    sns.set(style="white")

    # Set matplotlib
    mpl.rcParams['xtick.labelsize'] = 9
    mpl.rcParams['ytick.labelsize'] = 9
    mpl.rcParams['axes.titlesize'] = 11
    mpl.rcParams['legend.fontsize'] = 9

    # Pandas configuration
    pd.set_option('display.max_colwidth', 40)
    pd.set_option('display.width', 300)
    pd.set_option('display.precision', 4)

    # Numpy configuration
    np.set_printoptions(precision=2)


    # ------------------------------------------------------------
    # Methods
    # ------------------------------------------------------------
    def get_category_colors(index, category, cmap='hls'):
        """This method creates the colors for the different elements in
        categorical feature vector.

        Parameters
        ----------
        values : array-like
            The vector with the categorical values

        cmap: string-like
            The colormap to use

        default: string-like
            The color to be used for the first value. Note that this
            value needs to appear first on the the sorted list, as such
            it is recommended to set is as _default.

        Returns
        -------
        """
        # Get categories
        categories = index.get_level_values(category)
        # Get unique elements
        unique = np.unique(categories)
        # Create the palette
        palette = sns.color_palette(cmap, desat=0.5, n_colors=unique.shape[0])
        # Create mappers from category to color
        mapper = dict(zip(map(str, unique), palette))
        # Create list with colors for each category
        colors = pd.Series(categories, index=index).map(mapper)
        # Return
        return colors


    def create_mapper(dataframe, column_key, column_value):
      """This method constructs a mapper

      Parameters
      ----------
      dataframe: dataframe-like
        The dataframe from which the columns are extracted

      column_key: string-like
        The name of the column with the values for the keys of the mapper

      column_value: string-like
        The name of the column with the values for the values of the mapper

      Returns
      -------
      dictionary
      """
      dataframe = dataframe[[column_key, column_value]]
      dataframe = dataframe.drop_duplicates()
      return dict(zip(dataframe[column_key], dataframe[column_value]))


    # --------------------------------------------------------------------
    #                               Main
    # --------------------------------------------------------------------
    # Load data
    data, antibiotics, organisms = load_data_nhs()

    # Count records per specimen code
    specimen_code_count = data \
        .groupby('laboratory_number').head(1) \
        .specimen_code.value_counts(normalize=True) \
        .sort_values(ascending=False)

    # Filter most frequent specimens
    data = data[data.specimen_code.isin( \
        specimen_code_count.index.values[:5])]

    # Loop for each specimen
    for specimen_code, df in data.groupby(by='specimen_code'):

        # -------------------------------------------
        # Compute Freq and SARI
        # -------------------------------------------
        # Create instance
        freq = Frequency(column_antibiotic='antimicrobial_code',
                         column_organism='microorganism_code',
                         column_date='date_received',
                         column_outcome='sensitivity')

        # Compute frequencies (overall)
        freq_overall = freq.compute(df, by_category='pairs')

        # Filter
        freq_overall = freq_overall[freq_overall.sum(axis=1) > 100]

        # Compute SARI
        sari_overall = SARI(strategy='hard').compute(freq_overall)

        # -------------------------------
        # Create matrix
        # -------------------------------
        # Create mappers
        abx_map = create_mapper(antibiotics, 'antimicrobial_code', 'category')
        org_map = create_mapper(organisms, 'microorganism_code', 'genus')

        # Create matrix
        matrix = sari_overall.reset_index()
        matrix['microorganism_genus'] = matrix.SPECIE.map(org_map)
        matrix['antimicrobial_class'] = matrix.ANTIBIOTIC.map(abx_map)

        # Pivot table
        matrix = pd.pivot_table(matrix, values='sari',
            index=['SPECIE', 'microorganism_genus'],
            columns=['ANTIBIOTIC', 'antimicrobial_class'])

        # Convert to percent
        matrix = matrix * 100

        # Create mask
        mask = pd.isnull(matrix)

        # Fill missing (error when computing distance)
        matrix = matrix.fillna(1e-10)

        # Show
        print("\n\n\nData (%s)" % specimen_code)
        print(matrix.astype(int))

        # Create colormap
        cmap = sns.color_palette("Reds", desat=0.5, n_colors=10)

        # Row and col colors
        col_colors = get_category_colors( \
            index=matrix.columns, category=matrix.columns.names[1])
        row_colors = get_category_colors( \
            index=matrix.index, category=matrix.index.names[1])

        # .. note: It is possible to also pass kwargs that would
        #          be used by sns.heatmap function (annot, fmt,
        #          annot_kws, ...
        try:
            # Plot cluster map
            grid = sns.clustermap(data=matrix, vmin=0, vmax=100,
                cmap=cmap, #method='centroid', metric='euclidean',
                linewidth=0.05, mask=mask, square=True,
                row_colors=row_colors, col_colors=col_colors,
                yticklabels=1, xticklabels=1)

            # Set size
            #grid.fig.set_size_inches(20, 40)
            #grid.fig.subplots_adjust(right=0.5)

            # Set square heatmap.
            #grid.ax_heatmap.set(aspect="equal")

        except Exception as e:
            print("Exception: %s" % e)

        # Configuration
        plt.suptitle('Antibiogram (clustered) - %s' % specimen_code,
            fontsize=12)
        plt.tight_layout()

    # Show
    plt.show()

.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  13.199 seconds)


.. _sphx_glr_download__examples_reports_nhs_plot_antibiogram_clustermap.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_antibiogram_clustermap.py <plot_antibiogram_clustermap.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_antibiogram_clustermap.ipynb <plot_antibiogram_clustermap.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
