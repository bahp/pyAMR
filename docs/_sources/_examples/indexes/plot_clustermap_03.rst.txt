
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples\indexes\plot_clustermap_03.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_indexes_plot_clustermap_03.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_indexes_plot_clustermap_03.py:


SARI - Clustermap (by culture)
------------------------------

.. todo:: Explain...

.. GENERATED FROM PYTHON SOURCE LINES 8-196



.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /_examples/indexes/images/sphx_glr_plot_clustermap_03_001.png
          :alt: Antibiogram (clustered) - BLDCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/indexes/images/sphx_glr_plot_clustermap_03_002.png
          :alt: Antibiogram (clustered) - SPTCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/indexes/images/sphx_glr_plot_clustermap_03_003.png
          :alt: Antibiogram (clustered) - URICUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/indexes/images/sphx_glr_plot_clustermap_03_004.png
          :alt: Antibiogram (clustered) - WOUCUL
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/indexes/images/sphx_glr_plot_clustermap_03_005.png
          :alt: Antibiogram (clustered) - XINCUL
          :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    Data:
         dateReceived orderCode       orderName labNumber  patNumber         organismName organismCode antibioticName antibioticCode sensitivity
    0      2016-01-01    SPTCUL  sputum culture  F2403455          0  serratia marcescens         SMAR       amikacin           AAMI   sensitive
    1      2016-01-01    SPTCUL  sputum culture  F2403455          0  serratia marcescens         SMAR    amoxycillin           AAMO   resistant
    2      2016-01-01    SPTCUL  sputum culture  F2403455          0  serratia marcescens         SMAR  amp c markers          AAMPC   resistant
    3      2016-01-01    SPTCUL  sputum culture  F2403455          0  serratia marcescens         SMAR      augmentin           AAUG   resistant
    4      2016-01-01    SPTCUL  sputum culture  F2403455          0  serratia marcescens         SMAR      aztreonam           AAZT   sensitive
    ...           ...       ...             ...       ...        ...                  ...          ...            ...            ...         ...
    5147   2016-01-11    BLDCUL   blood culture  X1721650        400     escherichia coli         ECOL        tazocin           ATAZ   sensitive
    5148   2016-01-11    BLDCUL   blood culture  X1721650        400     escherichia coli         ECOL     temocillin           ATEM   sensitive
    5149   2016-01-11    BLDCUL   blood culture  X1721650        400     escherichia coli         ECOL    tigecycline           ATIG   sensitive
    5150   2016-01-11    BLDCUL   blood culture  X1721650        400     escherichia coli         ECOL     tobramycin           ATOB   sensitive
    5151   2016-01-11    BLDCUL   blood culture  X1721650        400     escherichia coli         ECOL   trimethoprim           ATRI   sensitive

    [5152 rows x 10 columns]

    Columns:
    Index(['dateReceived', 'orderCode', 'orderName', 'labNumber', 'patNumber', 'organismName', 'organismCode', 'antibioticName', 'antibioticCode', 'sensitivity'], dtype='object')



    Data (BLDCUL)
    antibiotic_code                         AAMI             AAMO        AAZT           ACAZ             ACIP       ACLA  ...        APEN        ATEM          ATET          ATIG            ATOB         AVAN
    antibiotic_class             aminoglycosides aminopenicillins monobactams cephalosporins fluoroquinolones macrolides  ... penicillins penicillins tetracyclines tetracyclines aminoglycosides glycopeptide
    organism_code genus_name                                                                                              ...                                                                                 
    BHSB          streptococcus                0                0           0              0                0          0  ...           0           0           100             0               0            0
    BOVA          bacteroides                  0                0           0              0                0          0  ...           0           0             0             0               0            0
    BREVI         brevibacterium               0                0           0              0                0          0  ...           0           0             0             0               0            0
    CNS           staphylococcus               0                0           0              0               18          0  ...           0           0             9             0               0            0
    DIPHT         diphtheroids                 0                0           0              0                0          0  ...           0           0             0             0               0            0
    ECOL          escherichia                  0               55          12             11               33          0  ...           0           0             0             0              12            0
    ENTAE         enterobacter                 0              100           0              0                0          0  ...           0           0             0             0               0            0
    HINF          haemophilus                  0                0           0              0                0        100  ...           0           0             0             0               0            0
    KOXY          klebsiella                   0              100           0              0                0          0  ...           0           0             0             0               0            0
    KPNE          klebsiella                   0              100          28             28               28          0  ...           0           0             0             0              28            0
    PAER          pseudomonas                  0                0         100              0                0          0  ...           0           0             0             0               0            0
    QGPBA         gram                         0                0           0              0                0          0  ...           0           0             0             0               0            0
    SAUR          staphylococcus               0                0           0              0               12          0  ...          87           0            12             0               0            0
    SLUG          staphylococcus               0                0           0              0                0          0  ...           0           0             0             0               0            0
    SMIL          streptococcus                0                0           0              0                0          0  ...           0           0             0             0               0            0
    SORA          streptococcus                0                0           0              0                0          0  ...         100           0             0             0               0            0
    VIRST         streptococcus                0                0           0              0                0          0  ...           0           0             0             0               0            0

    [17 rows x 24 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (SPTCUL)
    antibiotic_code                         AAMI             AAMO        AAZT           ACAZ             ACIP       ACLA  ...        APEN        ATEM          ATET          ATIG            ATOB         AVAN
    antibiotic_class             aminoglycosides aminopenicillins monobactams cephalosporins fluoroquinolones macrolides  ... penicillins penicillins tetracyclines tetracyclines aminoglycosides glycopeptide
    organism_code genus_name                                                                                              ...                                                                                 
    BHSB          streptococcus                0                0           0              0                0          0  ...           0           0           100             0               0            0
    CKOS          citrobacter                  0              100           0              0                0          0  ...           0           0             0             0               0            0
    CNS           staphylococcus               0                0           0              0              100          0  ...           0           0             0             0               0            0
    ECLO          enterobacter                 0               50           0              0                0          0  ...           0           0             0             0               0            0
    ECOL          escherichia                  0              100          33             33               66          0  ...           0           0             0             0              33            0
    ENTAE         enterobacter                 0              100           0              0                0          0  ...           0           0             0             0               0            0
    HAEMO         haemophilus                  0                0           0              0                0         50  ...           0           0             0             0               0            0
    HINF          haemophilus                  0               33           0              0                0         88  ...           0           0             0             0               0            0
    HPIN          haemophilus                  0                0           0              0                0        100  ...           0           0            50             0               0            0
    KPNE          klebsiella                   0              100          16             16               16          0  ...           0           0             0             0              16            0
    MCAT          moraxella                    0              100           0              0                0          0  ...           0           0             0             0               0            0
    PAER          pseudomonas                  0                0          80             20               30          0  ...           0           0             0             0              20            0
    PMIR          proteus                      0                0           0              0                0          0  ...           0           0             0             0               0            0
    SAUR          staphylococcus               0                0           0              0               10          0  ...          60           0             0             0               0            0
    SLIQ          serratia                     0              100           0              0                0          0  ...           0           0             0             0               0            0
    SMAR          serratia                     0              100           0              0                0          0  ...           0          25             0             0               0            0
    SPNE          streptococcus                0                0           0              0                0          0  ...           0           0             0             0               0            0
    YEAST         yeasts                       0              100           0              0                0          0  ...           0           0             0             0               0            0

    [18 rows x 25 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (URICUL)
    antibiotic_code                         AAMI             AAMO        AAZT           ACAZ          ACELX             ACIP  ...         ATEI        ATEM          ATET          ATIG            ATOB         AVAN
    antibiotic_class             aminoglycosides aminopenicillins monobactams cephalosporins cephalosporins fluoroquinolones  ... glycopeptide penicillins tetracyclines tetracyclines aminoglycosides glycopeptide
    organism_code genus_name                                                                                                  ...                                                                                  
    BHSB          streptococcus                0                0           0              0              0                0  ...            0           0            33             0               0            0
    CNS           staphylococcus               0                0           0              0              0                0  ...            0           0             0             0               0            0
    COLIF         coliform                     0                0           0              0             13                4  ...            0           0             0             0               0            0
    ECLO          enterobacter                 0                0           0              0            100                0  ...            0           0             0             0               0            0
    ECOL          escherichia                  0                0           0             33             11               22  ...            0          66             0             0              50            0
    EFAM          enterococcus                 0              100           0              0              0                0  ...          100           0             0             0               0          100
    EFAS          enterococcus                 0                0           0              0              0                0  ...          100           0             0             0               0          100
    ENTC          enterococcus                 0               23           0              0              0                0  ...           16           0             0             0               0           16
    KPNE          klebsiella                   0                0           0            100             66              100  ...            0           0             0             0             100            0
    PAER          pseudomonas                  0                0         100             11              0                0  ...            0           0             0             0               0            0
    PMIR          proteus                      0                0           0              0             28               14  ...            0           0             0             0               0            0
    PSEUD         pseudomonas                  0                0           0            100              0              100  ...            0           0             0             0               0            0
    SAUR          staphylococcus               0                0           0              0              0               50  ...            0           0             0             0               0            0
    SSAP          staphylococcus               0                0           0              0              0                0  ...            0           0             0             0               0            0

    [14 rows x 25 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (WOUCUL)
    antibiotic_code                           AAMI             AAMO        AAZT           ACAZ             ACIP       ACLI  ...         ATEI        ATEM          ATET          ATIG            ATOB         AVAN
    antibiotic_class               aminoglycosides aminopenicillins monobactams cephalosporins fluoroquinolones macrolides  ... glycopeptide penicillins tetracyclines tetracyclines aminoglycosides glycopeptide
    organism_code genus_name                                                                                                ...                                                                                  
    AFAE          alcaligenes                    0                0         100              0                0          0  ...            0           0             0             0               0            0
    ALWO          acinetobacter                  0                0           0              0                0          0  ...            0           0             0             0               0            0
    BHSA          streptococcus                  0                0           0              0                0          0  ...            0           0           100             0               0            0
    BHSB          streptococcus                  0                0           0              0                0        100  ...            0           0            40             0               0            0
    BHSCG         streptococcus                  0                0           0              0                0         50  ...            0           0           100             0               0            0
    CNS           staphylococcus                 0                0           0              0                0          0  ...            0           0             0             0               0            0
    COLIF         coliform                       0              100           0             25               20          0  ...            0          25             0             0               0            0
    ECOL          escherichia                    0              100          50             50                0          0  ...            0           0             0             0             100            0
    KPNE          klebsiella                     0              100           0              0                0          0  ...            0           0             0             0               0            0
    LFC           coliform                       0                0           0              0                0          0  ...            0           0             0             0               0            0
    PAER          pseudomonas                    0              100          66             20               20          0  ...            0         100             0           100               0            0
    PROTE         proteus                        0                0           0              0                0        100  ...            0           0             0             0               0            0
    PSEUD         pseudomonas                    0                0           0              0                0          0  ...            0           0             0             0               0            0
    SAUR          staphylococcus                 0                0           0              0               15         26  ...            0           0            19             0               0            0
    SMAL          stenotrophomonas               0                0           0              0                0          0  ...            0           0             0             0               0            0
    YEAST         yeasts                         0                0           0              0                0          0  ...            0           0             0             0               0            0

    [16 rows x 26 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)



    Data (XINCUL)
    antibiotic_code                        AAMI             AAMO        AAZT           ACAZ             ACIP         ACOL  ...       AERT            AGEN       AMER        ATEM          ATIG            ATOB
    antibiotic_class            aminoglycosides aminopenicillins monobactams cephalosporins fluoroquinolones polypeptides  ... meropenems aminoglycosides meropenems penicillins tetracyclines aminoglycosides
    organism_code genus_name                                                                                               ...                                                                                
    ABAU          acinetobacter               0                0           0              0                0            0  ...          0               0          0           0             0               0
    CFRE          citrobacter               100              100         100            100              100            0  ...        100             100          0         100             0             100
    ECOL          escherichia                25              100          37             50               75            0  ...         62              37         12          75             0              50
    ENTAE         enterobacter                0              100         100            100                0            0  ...        100               0          0         100             0               0
    KPNE          klebsiella                 42              100          78             85               78            0  ...         78              28         21         100            42              64

    [5 rows x 16 columns]
    c:\users\kelda\desktop\repositories\virtualenvs\venvpy39-datablend\lib\site-packages\seaborn\matrix.py:1216: UserWarning: ``square=True`` ignored in clustermap
      warnings.warn(msg)






|

.. code-block:: default
   :lineno-start: 9


    # Libraries
    import sys
    import numpy as np
    import pandas as pd
    import seaborn as sns
    import matplotlib as mpl
    import matplotlib.pyplot as plt

    # Import specific libraries
    from pyamr.core.sari import SARI
    from pyamr.core.freq import Frequency

    # -------------------------
    # Configuration
    # -------------------------
    # Configure seaborn style (context=talk)
    sns.set(style="white")

    # Set matplotlib
    mpl.rcParams['xtick.labelsize'] = 9
    mpl.rcParams['ytick.labelsize'] = 9
    mpl.rcParams['axes.titlesize'] = 11
    mpl.rcParams['legend.fontsize'] = 9

    # Pandas configuration
    pd.set_option('display.max_colwidth', 40)
    pd.set_option('display.width', 300)
    pd.set_option('display.precision', 4)

    # Numpy configuration
    np.set_printoptions(precision=2)

    # ------------------
    # Methods
    # ------------------
    def get_category_colors(index, category, cmap='tab10'):
        """This method creates the colors for the different elements in
        categorical feature vector.

        Parameters
        ----------
        values : array-like
            The vector with the categorical values

        cmap: string-like
            The colormap to use

        default: string-like
            The color to be used for the first value. Note that this
            value needs to appear first on the the sorted list, as such
            it is recommended to set is as _default.

        Returns
        -------
        """
        # Get categories
        categories = index.get_level_values(category)
        # Get unique elements
        unique = np.unique(categories)
        # Create the palette
        palette = sns.color_palette(cmap, desat=0.5, n_colors=unique.shape[0])
        # Create mappers from category to color
        mapper = dict(zip(map(str, unique), palette))
        # Create list with colors for each category
        colors = pd.Series(categories, index=index).map(mapper)
        # Return
        return colors


    # -------------------------------------------
    # Load data
    # -------------------------------------------
    # Path
    path = '../../pyamr/datasets/microbiology/susceptibility.csv'
    path_org = '../../pyamr/datasets/microbiology/db_microorganisms.csv'
    path_abx = '../../pyamr/datasets/microbiology/db_antimicrobials.csv'

    # Columns
    usecols = ['dateReceived',
               'labNumber',
               'patNumber',
               'orderName',
               'orderCode',
               'organismName',
               'organismCode',
               'antibioticName',
               'antibioticCode',
               'sensitivity']

    # Load data
    data = pd.read_csv(path, usecols=usecols,
        parse_dates=['dateReceived'])

    # Clean
    data = data.drop_duplicates()

    # Show
    print("\nData:")
    print(data)
    print("\nColumns:")
    print(data.columns)

    # -------------------------------------------
    # For each culture type
    # -------------------------------------------
    # Count records per order code
    order_code_count = data.orderCode.value_counts()

    # Filter most frequent order codes
    data = data[data.orderCode.isin( \
        order_code_count.index.values[:5])]

    # Loop
    for order_code, df in data.groupby(by='orderCode'):

        # -------------------------------------------
        # Compute Freq and SARI
        # -------------------------------------------
        # Create instance
        freq = Frequency(column_antibiotic='antibioticCode',
                         column_organism='organismCode',
                         column_date='dateReceived',
                         column_outcome='sensitivity')

        # Compute frequencies (overall)
        freq_overall = freq.compute(df, by_category='pairs')

        # Compute SARI
        sari_overall = SARI(strategy='hard').compute(freq_overall)

        # -------------------------------
        # Create matrix
        # -------------------------------
        # Load default datasets
        orgs = pd.read_csv(path_org)
        abxs = pd.read_csv(path_abx)

        # Format DataFrame
        matrix = sari_overall.reset_index()
        matrix = matrix.merge(orgs, how='left',
            left_on='SPECIE', right_on='organism_code')
        matrix = matrix.merge(abxs, how='left',
            left_on='ANTIBIOTIC', right_on='antibiotic_code')

        # Pivot table
        matrix = pd.pivot_table(matrix, values='sari',
           index=['organism_code', 'genus_name'],
           columns=['antibiotic_code', 'antibiotic_class'])

        # Convert to percent
        matrix = matrix * 100

        # Create mask
        mask = pd.isnull(matrix)

        # Fill missing (error when computing distance)
        matrix = matrix.fillna(1e-10)

        # Show
        print("\n\n\nData (%s)" % order_code)
        print(matrix.astype(int))

        # Create colormap
        cmap = sns.color_palette("Reds", desat=0.5, n_colors=10)

        # Row and col colors
        col_colors = get_category_colors( \
            index=matrix.columns, category=matrix.columns.names[1])
        row_colors = get_category_colors( \
            index=matrix.index, category=matrix.index.names[1])

        # .. note: It is possible to also pass kwargs that would
        #          be used by sns.heatmap function (annot, fmt,
        #          annot_kws, ...
        try:
            # Plot cluster map
            grid = sns.clustermap(data=matrix, vmin=0, vmax=100,
                method='centroid', metric='euclidean', cmap=cmap,
                linewidth=0.05, mask=mask, square=True,
                row_colors=row_colors, col_colors=col_colors)
        except Exception as e:
            print("Exception: %s" % e)
        # Configuration
        plt.suptitle('Antibiogram (clustered) - %s' % order_code)
        plt.tight_layout()

    # Show
    plt.show()

.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  3.439 seconds)


.. _sphx_glr_download__examples_indexes_plot_clustermap_03.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_clustermap_03.py <plot_clustermap_03.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_clustermap_03.ipynb <plot_clustermap_03.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
